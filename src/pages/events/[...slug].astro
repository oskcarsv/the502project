---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const events = await getCollection('events');
  return events.map(event => ({
    params: { slug: event.slug },
    props: { event },
  }));
}

const { event } = Astro.props;
const { Content } = await event.render();

// Parse date strings as noon to avoid timezone offset issues
const parseDate = (date: string) => new Date(date + 'T12:00:00');

const formatFullDate = (date: string) => {
  const d = parseDate(date);
  return d.toLocaleDateString('es-GT', {
    weekday: 'long',
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });
};

const formatDay = (date: string) => {
  return parseDate(date).getDate().toString();
};

const formatWeekday = (date: string) => {
  const d = parseDate(date);
  return d.toLocaleDateString('es-GT', { weekday: 'short' }).toUpperCase();
};

const formatMonth = (date: string) => {
  const d = parseDate(date);
  return d.toLocaleDateString('es-GT', { month: 'short' }).toUpperCase();
};

const getStatusBadge = (status: string) => {
  const badges: Record<string, { text: string; class: string; dot: string }> = {
    'open': { text: 'registro abierto', class: 'bg-502-green/10 text-502-green', dot: 'bg-502-green' },
    'waitlist': { text: 'lista de espera', class: 'bg-yellow-500/10 text-yellow-400', dot: 'bg-yellow-400' },
    'sold-out': { text: 'agotado', class: 'bg-red-500/10 text-red-400', dot: 'bg-red-400' },
    'requires-application': { text: 'requiere aplicación', class: 'bg-purple-500/10 text-purple-400', dot: 'bg-purple-400' },
    'past': { text: 'finalizado', class: 'bg-gray-500/10 text-gray-400', dot: 'bg-gray-400' }
  };
  return badges[status] || badges['open'];
};

const getTypeBadge = (type: string) => {
  const types: Record<string, { text: string; class: string }> = {
    'presencial': { text: 'presencial', class: 'text-502-green' },
    'virtual': { text: 'virtual', class: 'text-purple-400' },
    'hybrid': { text: 'híbrido', class: 'text-blue-400' }
  };
  return types[type] || types['presencial'];
};

const getRegistrationLabel = (status: string) => {
  if (status === 'requires-application') return 'aplicar ahora';
  if (status === 'sold-out') return 'agotado';
  if (status === 'waitlist') return 'unirme a lista de espera';
  return 'registrarme';
};

const regUrl = event.data.lumaUrl || event.data.customRegistrationUrl;
const today = new Date().toISOString().split('T')[0];
const isPast = event.data.date < today || event.data.status === 'past';

// Countdown
const eventDate = parseDate(event.data.date);
const now = new Date();
const diffMs = eventDate.getTime() - now.getTime();
const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
---

<Layout
  title={`${event.data.titleEs || event.data.title} | the502project`}
  description={event.data.descriptionEs || event.data.description}
  lang="es"
>
  <div class="min-h-screen grid-bg">
    <!-- Side Index Navigation (desktop) -->
    <nav class="hidden lg:flex fixed left-8 top-1/2 -translate-y-1/2 flex-col gap-4 z-50">
      <a href="/events" class="group flex items-center gap-3">
        <span class="relative w-2 h-2 flex items-center justify-center">
          <span class="absolute w-1.5 h-1.5 rounded-full bg-gray-600 group-hover:opacity-0 transition-opacity"></span>
          <svg class="absolute w-3 h-3 text-502-green opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
        </span>
        <span class="text-xs text-gray-500 group-hover:text-502-green transition-colors">eventos</span>
      </a>
      <a href="#detalles" class="nav-item group flex items-center gap-3">
        <span class="nav-indicator"></span>
        <span class="text-xs text-gray-500 group-hover:text-502-green transition-colors">detalles</span>
      </a>
      <a href="#descripcion" class="nav-item group flex items-center gap-3">
        <span class="nav-indicator"></span>
        <span class="text-xs text-gray-500 group-hover:text-502-green transition-colors">descripción</span>
      </a>
    </nav>

    <!-- Top bar -->
    <div class="fixed top-0 left-0 right-0 z-50 px-6 py-4 flex items-center justify-end">
      <div class="flex items-center gap-4 text-xs text-gray-500">
        <a href="/" class="hover:text-white">inicio</a>
        <a href="/events" class="hover:text-white">eventos</a>
        <a href="/blog" class="hover:text-white">blog</a>
        <a href={`/en/events/${event.slug}`} class="hover:text-502-green border-l border-white/10 pl-4">en</a>
      </div>
    </div>

    <!-- Main content -->
    <main class="max-w-4xl mx-auto px-6 lg:px-0 lg:ml-44 xl:ml-56">
      <div class="grid lg:grid-cols-[1fr_260px] lg:gap-12">

        <!-- Left column: header + description -->
        <div>
          <!-- Event Header -->
          <section id="detalles" class="min-h-screen flex flex-col justify-center py-20">
            <div class="fade-in">
              <!-- Back link mobile -->
              <a href="/events" class="inline-flex items-center gap-2 text-gray-500 hover:text-502-green text-sm mb-8 lg:hidden">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                todos los eventos
              </a>

              <!-- Past event banner -->
              {isPast && (
                <div class="mb-6 flex items-center gap-3 text-gray-500">
                  <div class="h-px flex-1 bg-gray-700"></div>
                  <span class="text-xs tracking-wider uppercase">te lo perdiste</span>
                  <div class="h-px flex-1 bg-gray-700"></div>
                </div>
              )}

              <!-- Badges -->
              <div class="flex flex-wrap items-center gap-3 mb-6">
                <span class={`inline-flex items-center gap-1.5 text-xs px-2.5 py-1 rounded-full ${getStatusBadge(event.data.status).class}`}>
                  <span class={`w-1.5 h-1.5 rounded-full ${getStatusBadge(event.data.status).dot}`}></span>
                  {getStatusBadge(event.data.status).text}
                </span>
                <span class={`text-xs ${getTypeBadge(event.data.type).class}`}>
                  {getTypeBadge(event.data.type).text}
                </span>
                {event.data.collaboration && (
                  <span class="text-xs text-gray-500">
                    con {event.data.collaboratorName}
                  </span>
                )}
              </div>

              <!-- Title -->
              <h1 class="text-3xl sm:text-4xl md:text-5xl mb-6 leading-tight">
                {event.data.titleEs || event.data.title}
              </h1>

              <!-- Description -->
              <p class="text-gray-400 text-lg leading-relaxed mb-10 max-w-2xl">
                {event.data.descriptionEs || event.data.description}
              </p>

              <!-- Countdown (mobile only, desktop shows in sidebar) -->
              {!isPast && diffDays > 0 && (
                <p class="text-sm text-gray-500 mb-10 lg:hidden">
                  empieza en <span class="text-502-green font-medium">{diffDays} {diffDays === 1 ? 'día' : 'días'}</span>
                </p>
              )}

              <!-- Mobile event info card -->
              <div class="lg:hidden border border-white/10 p-6 mb-6">
                <div class="flex items-start gap-5">
                  <div class="flex flex-col items-center min-w-[60px]">
                    <span class="text-[10px] uppercase tracking-wider text-gray-500">{formatMonth(event.data.date)}</span>
                    <span class="text-4xl font-light text-white leading-none my-1">{formatDay(event.data.date)}</span>
                    <span class="text-xs text-gray-600">{formatWeekday(event.data.date)}</span>
                  </div>
                  <div class="flex-1 space-y-3">
                    <div>
                      <span class="text-xs text-gray-600 block mb-1">fecha</span>
                      <span class="text-gray-300 text-sm">{formatFullDate(event.data.date)}</span>
                    </div>
                    <div>
                      <span class="text-xs text-gray-600 block mb-1">hora</span>
                      <span class="text-gray-300 text-sm">{event.data.time}{event.data.endTime && ` – ${event.data.endTime}`}</span>
                    </div>
                    {event.data.collaboration && (
                      <div>
                        <span class="text-xs text-gray-600 block mb-1">colaboración</span>
                        {event.data.collaboratorUrl ? (
                          <a href={event.data.collaboratorUrl} target="_blank" rel="noopener noreferrer" class="text-gray-300 text-sm hover:text-502-green transition-colors inline-flex items-center gap-1">
                            {event.data.collaboratorName}
                            <svg class="w-3 h-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                            </svg>
                          </a>
                        ) : (
                          <span class="text-gray-300 text-sm">{event.data.collaboratorName}</span>
                        )}
                      </div>
                    )}
                  </div>
                </div>

                {regUrl && !isPast && event.data.status !== 'sold-out' && (
                  <a
                    href={regUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="flex items-center justify-center gap-3 w-full bg-502-green text-502-black px-6 py-3.5 text-sm font-medium hover:opacity-90 transition-opacity mt-6"
                  >
                    {getRegistrationLabel(event.data.status)}
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                  </a>
                )}

                {isPast && event.data.recordingUrl && (
                  <a
                    href={event.data.recordingUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="flex items-center justify-center gap-2 w-full border border-white/10 text-white hover:text-502-green hover:border-502-green/50 px-6 py-3 text-sm transition-colors mt-6"
                  >
                    <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M8 5v14l11-7z"/>
                    </svg>
                    ver grabación
                  </a>
                )}

                {isPast && regUrl && (
                  <a
                    href={regUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    class={`flex items-center justify-center gap-2 w-full border border-white/10 text-gray-400 hover:text-white px-6 py-3 text-sm transition-colors ${event.data.recordingUrl ? 'mt-3' : 'mt-6'}`}
                  >
                    ver en luma
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                  </a>
                )}
              </div>
            </div>
          </section>

          <!-- Full Description -->
          <section id="descripcion" class="fade-in py-24 border-t border-white/5">
            <span class="text-502-green text-xs tracking-wider mb-8 block">DESCRIPCIÓN</span>

            <div class="prose prose-invert prose-gray max-w-none
              prose-headings:text-white prose-headings:font-normal
              prose-p:text-gray-400 prose-p:leading-relaxed
              prose-li:text-gray-400
              prose-strong:text-white
              prose-a:text-502-green prose-a:no-underline hover:prose-a:underline
              prose-hr:border-white/10
            ">
              <Content />
            </div>
          </section>
        </div>

        <!-- Right sidebar: sticky, vertically centered -->
        <aside class="hidden lg:block relative">
          <div class="sticky top-0 h-screen flex items-center py-8">
            <div class="space-y-6 w-full">

            <!-- Date card -->
            <div class="border border-white/10 p-5">
              <div class="flex flex-col items-center text-center mb-4">
                <span class="text-[10px] uppercase tracking-wider text-gray-500">{formatMonth(event.data.date)}</span>
                <span class="text-5xl font-light text-white leading-none my-1">{formatDay(event.data.date)}</span>
                <span class="text-xs text-gray-600">{formatWeekday(event.data.date)}</span>
              </div>
              <div class="border-t border-white/10 pt-4 space-y-3">
                <div class="flex items-center gap-3 text-sm">
                  <svg class="w-4 h-4 text-gray-600 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span class="text-gray-300">{event.data.time}{event.data.endTime && ` – ${event.data.endTime}`}</span>
                </div>
                <div class="flex items-center gap-3 text-sm">
                  <svg class="w-4 h-4 text-gray-600 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  <span class={`text-sm ${getTypeBadge(event.data.type).class}`}>{getTypeBadge(event.data.type).text}</span>
                </div>
              </div>
            </div>

            <!-- Collaboration -->
            {event.data.collaboration && (
              <div class="border border-white/10 p-5">
                <span class="text-[10px] uppercase tracking-wider text-gray-600 block mb-3">colaboración</span>
                {event.data.collaboratorUrl ? (
                  <a href={event.data.collaboratorUrl} target="_blank" rel="noopener noreferrer" class="text-white text-sm hover:text-502-green transition-colors inline-flex items-center gap-1.5">
                    {event.data.collaboratorName}
                    <svg class="w-3 h-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                  </a>
                ) : (
                  <span class="text-white text-sm">{event.data.collaboratorName}</span>
                )}
              </div>
            )}

            <!-- Registration CTA -->
            {regUrl && !isPast && event.data.status !== 'sold-out' && (
              <a
                href={regUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="flex items-center justify-center gap-3 w-full bg-502-green text-502-black px-6 py-3.5 text-sm font-medium hover:opacity-90 transition-opacity"
              >
                {getRegistrationLabel(event.data.status)}
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
              </a>
            )}

            {isPast && event.data.recordingUrl && (
              <a
                href={event.data.recordingUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="flex items-center justify-center gap-2 w-full border border-white/10 text-white hover:text-502-green hover:border-502-green/50 px-6 py-3 text-sm transition-colors"
              >
                <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M8 5v14l11-7z"/>
                </svg>
                ver grabación
              </a>
            )}

            {isPast && regUrl && (
              <a
                href={regUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="flex items-center justify-center gap-2 w-full border border-white/10 text-gray-400 hover:text-white hover:border-white/20 px-6 py-3 text-sm transition-colors"
              >
                ver en luma
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
              </a>
            )}

            <!-- Countdown -->
            {!isPast && diffDays > 0 && (
              <p class="text-center text-xs text-gray-600">
                empieza en <span class="text-502-green">{diffDays}d</span>
              </p>
            )}
            </div>
          </div>
        </aside>

      </div>

      <!-- Footer -->
      <footer class="py-16 border-t border-white/5">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-6">
          <div class="flex items-center gap-2">
            <svg class="w-5 h-5 text-502-green" viewBox="0 0 100 100" fill="currentColor">
              <rect x="10" y="10" width="35" height="35" rx="2"/>
              <path d="M55 10 Q90 10 90 45 L55 45 Z"/>
              <path d="M10 55 Q10 90 45 90 L45 55 Z"/>
              <path d="M55 55 Q90 55 90 90 L55 90 Z"/>
            </svg>
            <span class="text-xs text-gray-500">the502project</span>
          </div>

          <div class="flex flex-wrap gap-4 text-xs text-gray-500">
            <a href="/code" class="hover:text-502-green">código de conducta</a>
            <a href="mailto:hello@the502project.com" class="hover:text-502-green">contacto</a>
          </div>
        </div>
      </footer>

    </main>
  </div>

  <script>
    const sections = document.querySelectorAll('section[id]');
    const navItems = document.querySelectorAll('.nav-item');

    window.addEventListener('scroll', () => {
      let current = '';
      sections.forEach(section => {
        const sectionTop = section.offsetTop;
        if (scrollY >= sectionTop - 300) {
          current = section.getAttribute('id') || '';
        }
      });

      navItems.forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('href') === `#${current}`) {
          item.classList.add('active');
        }
      });
    });
  </script>
</Layout>
