---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const posts = allPosts.sort((a, b) => b.data.pubDate.localeCompare(a.data.pubDate));

const parseDate = (date: string) => new Date(date + 'T12:00:00');

const formatDate = (date: string) => {
  const d = parseDate(date);
  return d.toLocaleDateString('en-US', {
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });
};

const getTitle = (post: typeof allPosts[0]) => post.data.titleEn || post.data.title;
const getDescription = (post: typeof allPosts[0]) => post.data.descriptionEn || post.data.description;
---

<Layout
  title="Blog | the502project"
  description="Reflections and voices from the 502 community"
  lang="en"
>
  <div class="min-h-screen grid-bg">
    <nav class="hidden lg:flex fixed left-8 top-1/2 -translate-y-1/2 flex-col gap-4 z-50">
      <a href="/en" class="group flex items-center gap-3">
        <span class="relative w-2 h-2 flex items-center justify-center">
          <span class="absolute w-1.5 h-1.5 rounded-full bg-gray-600 group-hover:opacity-0 transition-opacity"></span>
          <svg class="absolute w-3 h-3 text-502-green opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
        </span>
        <span class="text-xs text-gray-500 group-hover:text-502-green transition-colors">back</span>
      </a>
      <a href="#articles" class="nav-item group flex items-center gap-3">
        <span class="nav-indicator"></span>
        <span class="text-xs text-gray-500 group-hover:text-502-green transition-colors">articles</span>
      </a>
    </nav>

    <div class="fixed top-0 left-0 right-0 z-50 px-6 py-4 flex items-center justify-end">
      <div class="flex items-center gap-4 text-xs text-gray-500">
        <a href="/en" class="hover:text-white">home</a>
        <a href="/en/events" class="hover:text-white">events</a>
        <a href="/blog" class="hover:text-502-green border-l border-white/10 pl-4">es</a>
      </div>
    </div>

    <main class="max-w-3xl mx-auto px-6 lg:px-0 lg:ml-44 xl:ml-56">
      <section id="articles" class="fade-in min-h-screen flex flex-col justify-center py-20">
        <span class="text-502-green text-xs tracking-wider mb-8 block">BLOG</span>

        <h1 class="text-4xl sm:text-5xl md:text-6xl mb-6">
          community <span class="italic">voices</span>
        </h1>
        <p class="text-gray-400 text-lg max-w-lg mb-16">
          Reflections, learnings, and stories from builders in Guatemala.
        </p>

        <div class="space-y-0">
          {posts.map((post) => (
            <a
              href={`/en/blog/${post.slug}`}
              class="stagger-item group border-b border-white/10 py-8 block"
            >
              <div class="min-w-0">
                <h2 class="text-xl md:text-2xl mb-2 group-hover:text-502-green transition-colors">
                  {getTitle(post)}
                </h2>
                <p class="text-gray-500 text-sm mb-3 line-clamp-2">
                  {getDescription(post)}
                </p>
                <div class="flex flex-wrap items-center gap-3 text-xs text-gray-600">
                  <span>{post.data.author}</span>
                  <span>Â·</span>
                  <time datetime={post.data.pubDate}>{formatDate(post.data.pubDate)}</time>
                </div>
              </div>
            </a>
          ))}
        </div>

        {posts.length === 0 && (
          <div class="fade-in border border-white/10 p-8 text-center">
            <p class="text-gray-400">more articles coming soon</p>
          </div>
        )}
      </section>

      <footer class="py-16 border-t border-white/5">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-6">
          <div class="flex items-center gap-2">
            <svg class="w-5 h-5 text-502-green" viewBox="0 0 100 100" fill="currentColor">
              <rect x="10" y="10" width="35" height="35" rx="2"/>
              <path d="M55 10 Q90 10 90 45 L55 45 Z"/>
              <path d="M10 55 Q10 90 45 90 L45 55 Z"/>
              <path d="M55 55 Q90 55 90 90 L55 90 Z"/>
            </svg>
            <span class="text-xs text-gray-500">the502project</span>
          </div>
          <div class="flex flex-wrap gap-4 text-xs text-gray-500">
            <a href="/en/code" class="hover:text-502-green">code of conduct</a>
            <a href="mailto:hello@the502project.com" class="hover:text-502-green">contact</a>
          </div>
        </div>
      </footer>
    </main>
  </div>

  <script>
    const sections = document.querySelectorAll('section[id]');
    const navItems = document.querySelectorAll('.nav-item');
    window.addEventListener('scroll', () => {
      let current = '';
      sections.forEach(section => {
        if (scrollY >= section.offsetTop - 300) current = section.getAttribute('id') || '';
      });
      navItems.forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('href') === `#${current}`) item.classList.add('active');
      });
    });
  </script>
</Layout>
