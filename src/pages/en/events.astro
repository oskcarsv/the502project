---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const links = {
  discord: 'https://discord.gg/AZeuYhCu',
  whatsapp: 'https://chat.whatsapp.com/JNvMJwm9Y0aDOBEQj3sFkM'
};

const allEvents = await getCollection('events');
const today = new Date().toISOString().split('T')[0];

// Parse date strings as noon to avoid timezone offset issues
const parseDate = (date: string) => new Date(date + 'T12:00:00');

const upcomingEvents = allEvents
  .filter(event => event.data.date >= today && event.data.status !== 'past')
  .sort((a, b) => a.data.date.localeCompare(b.data.date));

const pastEvents = allEvents
  .filter(event => event.data.date < today || event.data.status === 'past')
  .sort((a, b) => b.data.date.localeCompare(a.data.date));

const featuredEvent = upcomingEvents.find(e => e.data.featured) || upcomingEvents[0];
const otherUpcoming = upcomingEvents.filter(e => e.slug !== featuredEvent?.slug);

// Build calendar data - months that have events
const eventMonths = new Map<string, { month: string; year: number; events: typeof allEvents }>();
allEvents.forEach(event => {
  const d = parseDate(event.data.date);
  const key = `${d.getFullYear()}-${String(d.getMonth()).padStart(2, '0')}`;
  if (!eventMonths.has(key)) {
    eventMonths.set(key, {
      month: d.toLocaleDateString('en-US', { month: 'long' }),
      year: d.getFullYear(),
      events: []
    });
  }
  eventMonths.get(key)!.events.push(event);
});
const sortedMonths = [...eventMonths.entries()].sort((a, b) => b[0].localeCompare(a[0]));
const recentMonths = sortedMonths.slice(0, 3);
const olderMonths = sortedMonths.slice(3);

const formatDate = (date: string) => {
  const d = parseDate(date);
  return d.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
};

const formatFullDate = (date: string) => {
  const d = parseDate(date);
  return d.toLocaleDateString('en-US', {
    weekday: 'long',
    day: 'numeric',
    month: 'long',
  });
};

const formatDay = (date: string) => {
  return parseDate(date).getDate().toString();
};

const formatWeekday = (date: string) => {
  const d = parseDate(date);
  return d.toLocaleDateString('en-US', { weekday: 'short' }).toUpperCase();
};

const getStatusBadge = (status: string) => {
  const badges: Record<string, { text: string; class: string; dot: string }> = {
    'open': { text: 'registration open', class: 'bg-502-green/10 text-502-green', dot: 'bg-502-green' },
    'waitlist': { text: 'waitlist', class: 'bg-yellow-500/10 text-yellow-400', dot: 'bg-yellow-400' },
    'sold-out': { text: 'sold out', class: 'bg-red-500/10 text-red-400', dot: 'bg-red-400' },
    'requires-application': { text: 'application required', class: 'bg-purple-500/10 text-purple-400', dot: 'bg-purple-400' },
    'past': { text: 'ended', class: 'bg-gray-500/10 text-gray-400', dot: 'bg-gray-400' }
  };
  return badges[status] || badges['open'];
};

const getTypeBadge = (type: string) => {
  const types: Record<string, { text: string; class: string }> = {
    'presencial': { text: 'in-person', class: 'text-502-green' },
    'virtual': { text: 'virtual', class: 'text-purple-400' },
    'hybrid': { text: 'hybrid', class: 'text-blue-400' }
  };
  return types[type] || types['presencial'];
};

const getRegistrationLabel = (event: typeof allEvents[0]) => {
  if (event.data.status === 'requires-application') return 'apply';
  if (event.data.status === 'sold-out') return 'sold out';
  if (event.data.status === 'waitlist') return 'join waitlist';
  return 'register';
};
---

<Layout
  title="Events | the502project"
  description="community event board"
  lang="en"
>
  <div class="min-h-screen grid-bg">
    <!-- Side Index Navigation (desktop) -->
    <nav class="hidden lg:flex fixed left-8 top-1/2 -translate-y-1/2 flex-col gap-4 z-50">
      <a href="/en" class="group flex items-center gap-3">
        <span class="relative w-2 h-2 flex items-center justify-center">
          <span class="absolute w-1.5 h-1.5 rounded-full bg-gray-600 group-hover:opacity-0 transition-opacity"></span>
          <svg class="absolute w-3 h-3 text-502-green opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
        </span>
        <span class="text-xs text-gray-500 group-hover:text-502-green transition-colors">back</span>
      </a>
      <a href="#upcoming" class="nav-item group flex items-center gap-3">
        <span class="nav-indicator"></span>
        <span class="text-xs text-gray-500 group-hover:text-502-green transition-colors">upcoming</span>
      </a>
      <a href="#timeline" class="nav-item group flex items-center gap-3">
        <span class="nav-indicator"></span>
        <span class="text-xs text-gray-500 group-hover:text-502-green transition-colors">timeline</span>
      </a>
      <a href="#propose" class="nav-item group flex items-center gap-3">
        <span class="nav-indicator"></span>
        <span class="text-xs text-gray-500 group-hover:text-502-green transition-colors">propose</span>
      </a>
    </nav>

    <!-- Top bar -->
    <div class="fixed top-0 left-0 right-0 z-50 px-6 py-4 flex items-center justify-end">
      <div class="flex items-center gap-4 text-xs text-gray-500">
        <a href="/en" class="hover:text-white lg:hidden">home</a>
        <a href="/en/initiatives" class="hover:text-white lg:hidden">initiatives</a>
        <a href="/events" class="hover:text-502-green border-l border-white/10 pl-4">es</a>
      </div>
    </div>

    <!-- Main content -->
    <main class="max-w-3xl mx-auto px-6 lg:px-0 lg:ml-44 xl:ml-56">

      <!-- Upcoming Events Section -->
      <section id="upcoming" class="min-h-screen flex flex-col justify-center py-20">
        <span class="text-502-green text-xs tracking-wider mb-8 block">EVENTS</span>

        <h1 class="text-4xl sm:text-5xl md:text-6xl mb-6">
          where things <span class="italic">happen</span>
        </h1>
        <p class="text-gray-400 text-lg max-w-lg mb-16">
          founders and top builders sharing what actually works.
          action, not motivational talks.
        </p>

        <!-- Featured Event -->
        {featuredEvent && (
          <div class="fade-in mb-10">
            <p class="text-gray-500 text-sm mb-4">next event</p>
            <a
              href={`/en/events/${featuredEvent.slug}`}
              class="block group"
            >
              <div class="border border-white/10 hover:border-502-green/50 transition-all duration-300 p-6 md:p-8">
                <div class="flex items-start gap-5 md:gap-8">
                  <!-- Date block -->
                  <div class="hidden sm:flex flex-col items-center min-w-[60px] pt-1">
                    <span class="text-xs text-gray-500 tracking-wider">{formatWeekday(featuredEvent.data.date)}</span>
                    <span class="text-3xl md:text-4xl font-light text-white">{formatDay(featuredEvent.data.date)}</span>
                  </div>

                  <div class="flex-1">
                    <div class="flex flex-wrap items-center gap-2 mb-3">
                      <span class={`inline-flex items-center gap-1.5 text-xs px-2.5 py-1 rounded-full ${getStatusBadge(featuredEvent.data.status).class}`}>
                        <span class={`w-1.5 h-1.5 rounded-full ${getStatusBadge(featuredEvent.data.status).dot}`}></span>
                        {getStatusBadge(featuredEvent.data.status).text}
                      </span>
                      <span class={`text-xs ${getTypeBadge(featuredEvent.data.type).class}`}>
                        {getTypeBadge(featuredEvent.data.type).text}
                      </span>
                      {featuredEvent.data.collaboration && (
                        <span class="text-xs text-gray-500">
                          with {featuredEvent.data.collaboratorName}
                        </span>
                      )}
                    </div>

                    <h2 class="text-2xl md:text-3xl mb-3 group-hover:text-502-green transition-colors">
                      {featuredEvent.data.title}
                    </h2>

                    <p class="text-gray-400 text-sm md:text-base mb-5 leading-relaxed">
                      {featuredEvent.data.description}
                    </p>

                    <div class="flex flex-wrap items-center gap-5 text-sm text-gray-400">
                      <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <span>{formatFullDate(featuredEvent.data.date)}</span>
                      </div>
                      <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>{featuredEvent.data.time}{featuredEvent.data.endTime && ` - ${featuredEvent.data.endTime}`}</span>
                      </div>
                    </div>

                    {(featuredEvent.data.lumaUrl || featuredEvent.data.customRegistrationUrl) && featuredEvent.data.status !== 'sold-out' && (
                      <div class="mt-5 pt-5 border-t border-white/10">
                        <span class="inline-flex items-center gap-2 text-502-green text-sm group-hover:underline">
                          {getRegistrationLabel(featuredEvent)}
                          <svg class="w-4 h-4 transition-transform group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                          </svg>
                        </span>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </a>
          </div>
        )}

        <!-- Other Upcoming Events -->
        {otherUpcoming.length > 0 && (
          <div class="fade-in">
            <p class="text-gray-500 text-sm mb-4">more events</p>
            <div class="space-y-0">
              {otherUpcoming.map((event) => (
                <a
                  href={`/en/events/${event.slug}`}
                  class="stagger-item group border-b border-white/10 py-5 flex items-start gap-5 md:gap-8 block"
                >
                  <!-- Date block -->
                  <div class="hidden sm:flex flex-col items-center min-w-[60px] pt-1">
                    <span class="text-xs text-gray-600 tracking-wider">{formatWeekday(event.data.date)}</span>
                    <span class="text-2xl font-light text-gray-400 group-hover:text-white transition-colors">{formatDay(event.data.date)}</span>
                  </div>

                  <div class="flex-1">
                    <div class="flex flex-wrap items-center gap-2 mb-1">
                      <span class={`text-xs ${getTypeBadge(event.data.type).class}`}>
                        {getTypeBadge(event.data.type).text}
                      </span>
                      <span class={`inline-flex items-center gap-1.5 text-xs px-2 py-0.5 rounded-full ${getStatusBadge(event.data.status).class}`}>
                        <span class={`w-1 h-1 rounded-full ${getStatusBadge(event.data.status).dot}`}></span>
                        {getStatusBadge(event.data.status).text}
                      </span>
                      {event.data.collaboration && (
                        <span class="text-xs text-gray-600">with {event.data.collaboratorName}</span>
                      )}
                    </div>
                    <h3 class="text-lg md:text-xl group-hover:text-502-green transition-colors mb-1">
                      {event.data.title}
                    </h3>
                    <p class="text-gray-500 text-sm leading-relaxed">
                      {event.data.description}
                    </p>
                    <div class="flex items-center gap-4 mt-2 text-xs text-gray-600">
                      <span>{formatDate(event.data.date)}</span>
                      <span>{event.data.time}{event.data.endTime && ` - ${event.data.endTime}`}</span>
                    </div>
                  </div>
                </a>
              ))}
            </div>
          </div>
        )}

        {upcomingEvents.length === 0 && (
          <div class="fade-in border border-white/10 p-8 text-center">
            <p class="text-gray-400 mb-4">no events scheduled right now</p>
            <a href="#propose" class="text-502-green hover:underline">propose one</a>
          </div>
        )}
      </section>

      <!-- Calendar Timeline Section -->
      <section id="timeline" class="fade-in py-24 border-t border-white/5">
        <span class="text-502-green text-xs tracking-wider mb-8 block">TIMELINE</span>

        <h2 class="text-3xl sm:text-4xl mb-10">
          event <span class="italic">timeline</span>
        </h2>

        <div class="space-y-8">
          {recentMonths.map(([key, { month, year, events }]) => (
            <div class="stagger-item">
              <div class="flex items-baseline gap-3 mb-4">
                <h3 class="text-lg capitalize text-white">{month}</h3>
                <span class="text-sm text-gray-600">{year}</span>
                <span class="text-xs text-gray-700">{events.length} {events.length === 1 ? 'event' : 'events'}</span>
              </div>
              <div class="space-y-0 border-l border-white/10 ml-1 pl-6">
                {events.sort((a, b) => a.data.date.localeCompare(b.data.date)).map((event) => {
                  const isPast = event.data.date < today || event.data.status === 'past';
                  return (
                    <div class={`relative py-3 ${isPast ? 'opacity-50' : ''}`}>
                      <div class="absolute -left-[29px] top-5 w-2 h-2 rounded-full bg-white/20" />
                      <a href={`/en/events/${event.slug}`} class="group block">
                        <div class="flex items-baseline gap-3">
                          <span class="text-sm text-gray-500 min-w-[40px]">{formatDay(event.data.date)}</span>
                          <span class="text-base group-hover:text-502-green transition-colors">{event.data.title}</span>
                          {event.data.collaboration && (
                            <span class="text-xs text-gray-600">· {event.data.collaboratorName}</span>
                          )}
                        </div>
                        <div class="flex items-center gap-3 ml-[52px] mt-1">
                          <span class={`text-xs ${getTypeBadge(event.data.type).class}`}>{getTypeBadge(event.data.type).text}</span>
                          <span class="text-xs text-gray-600">{event.data.time}</span>
                          {isPast && <span class="text-xs px-1.5 py-0.5 rounded bg-gray-500/10 text-gray-500">you missed it</span>}
                        </div>
                      </a>
                    </div>
                  );
                })}
              </div>
            </div>
          ))}
        </div>

        {olderMonths.length > 0 && (
          <div class="mt-8">
            <button
              id="toggle-older-events"
              class="inline-flex items-center gap-2 text-gray-500 hover:text-502-green text-sm transition-colors"
            >
              <span id="toggle-text">see all events</span>
              <svg id="toggle-icon" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            <div id="older-events" class="hidden space-y-8 mt-8">
              {olderMonths.map(([key, { month, year, events }]) => (
                <div>
                  <div class="flex items-baseline gap-3 mb-4">
                    <h3 class="text-lg capitalize text-white">{month}</h3>
                    <span class="text-sm text-gray-600">{year}</span>
                    <span class="text-xs text-gray-700">{events.length} {events.length === 1 ? 'event' : 'events'}</span>
                  </div>
                  <div class="space-y-0 border-l border-white/10 ml-1 pl-6">
                    {events.sort((a, b) => a.data.date.localeCompare(b.data.date)).map((event) => {
                      const isPast = event.data.date < today || event.data.status === 'past';
                      return (
                        <div class={`relative py-3 ${isPast ? 'opacity-50' : ''}`}>
                          <div class="absolute -left-[29px] top-5 w-2 h-2 rounded-full bg-white/20" />
                          <a href={`/en/events/${event.slug}`} class="group block">
                            <div class="flex items-baseline gap-3">
                              <span class="text-sm text-gray-500 min-w-[40px]">{formatDay(event.data.date)}</span>
                              <span class="text-base group-hover:text-502-green transition-colors">{event.data.title}</span>
                              {event.data.collaboration && (
                                <span class="text-xs text-gray-600">· {event.data.collaboratorName}</span>
                              )}
                            </div>
                            <div class="flex items-center gap-3 ml-[52px] mt-1">
                              <span class={`text-xs ${getTypeBadge(event.data.type).class}`}>{getTypeBadge(event.data.type).text}</span>
                              <span class="text-xs text-gray-600">{event.data.time}</span>
                              {isPast && <span class="text-xs px-1.5 py-0.5 rounded bg-gray-500/10 text-gray-500">you missed it</span>}
                            </div>
                          </a>
                        </div>
                      );
                    })}
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}
      </section>

      <!-- Propose Section -->
      <section id="propose" class="fade-in min-h-screen flex flex-col justify-center py-24 border-t border-white/5">
        <span class="text-502-green text-xs tracking-wider mb-8 block">PROPOSE</span>

        <h2 class="text-4xl sm:text-5xl mb-8">
          <span class="italic">propose</span> something
        </h2>

        <p class="text-gray-400 text-lg mb-10 max-w-lg">
          have an idea for an event? workshops, talks, gatherings.
          this community is yours.
        </p>

        <div class="flex flex-col gap-4">
          <a
            href={links.whatsapp}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-2 text-502-green hover:underline"
          >
            propose on whatsapp
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
            </svg>
          </a>
          <a
            href={links.discord}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-2 text-gray-400 hover:text-502-green hover:underline transition-colors"
          >
            propose on discord
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
            </svg>
          </a>
        </div>
      </section>

      <!-- Footer -->
      <footer class="py-16 border-t border-white/5">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-6">
          <div class="flex items-center gap-2">
            <svg class="w-5 h-5 text-502-green" viewBox="0 0 100 100" fill="currentColor">
              <rect x="10" y="10" width="35" height="35" rx="2"/>
              <path d="M55 10 Q90 10 90 45 L55 45 Z"/>
              <path d="M10 55 Q10 90 45 90 L45 55 Z"/>
              <path d="M55 55 Q90 55 90 90 L55 90 Z"/>
            </svg>
            <span class="text-xs text-gray-500">the502project</span>
          </div>

          <div class="flex flex-wrap gap-4 text-xs text-gray-500">
            <a href="/en/code" class="hover:text-502-green">code of conduct</a>
            <a href="mailto:hello@the502project.com" class="hover:text-502-green">contact</a>
          </div>
        </div>
      </footer>

    </main>
  </div>

  <script>
    const sections = document.querySelectorAll('section[id]');
    const navItems = document.querySelectorAll('.nav-item');

    window.addEventListener('scroll', () => {
      let current = '';
      sections.forEach(section => {
        const sectionTop = section.offsetTop;
        if (scrollY >= sectionTop - 300) {
          current = section.getAttribute('id') || '';
        }
      });

      navItems.forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('href') === `#${current}`) {
          item.classList.add('active');
        }
      });
    });

    const toggleBtn = document.getElementById('toggle-older-events');
    const olderEvents = document.getElementById('older-events');
    const toggleText = document.getElementById('toggle-text');
    const toggleIcon = document.getElementById('toggle-icon');

    if (toggleBtn && olderEvents) {
      toggleBtn.addEventListener('click', () => {
        const isHidden = olderEvents.classList.contains('hidden');
        olderEvents.classList.toggle('hidden');
        if (toggleText) toggleText.textContent = isHidden ? 'hide older events' : 'see all events';
        if (toggleIcon) toggleIcon.style.transform = isHidden ? 'rotate(180deg)' : '';
      });
    }
  </script>
</Layout>
